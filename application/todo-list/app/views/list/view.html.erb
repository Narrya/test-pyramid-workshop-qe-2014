<h1 class="section-title"><%= @current_user %>: "<%= h(@list.name) %>" tasks </h1>
<ul class="task-list">
<% @list.tasks.each do |task| %>
  <li class="task-list__task cf">
    <input type="checkbox"
           class="task-state transition pressable"
           data-task-id="<%= task.id %>"
           data-list-id="<%= @list.id %>"
           <% if task.closed %>checked="checked"<% end %> >
    <div class="task-list__task__info">
        <span class="task-list__task__info__date"><%= h(task.date) %></span>
        <span class="task-list__task__info__title"><%= h(task.title) %></span>
    </div>
    <input type="button" class="task-list__task__delete transition" data-task-id="<%= task.id %>" data-list-id="<%= @list.id %>" value="Delete" />
  </li>
<% end %>
</ul>


<hr class="segment-divider" />
<section id="new-task" class="control-group">
  <div>
    <a href="/" class="topcoat-button-bar__button--large data-entry__back transition pressable">Back</a>
    <input type="text" class="topcoat-text-input data-entry__input transition" id="new-task-title" value="" placeholder="Title of the new task..." />
    <input type="button" class="topcoat-button-bar__button--large data-entry__submit transition topcoat-button--large--cta pressable" id="add-new-task" data-list-id="<%= @list.id %>" value="Add" />
  </div>
</section>

<section class="hidden">
  <input type="button" id="reopen-list" data-list-id="<%= @list.id %>" value="Reopen" />
</section>

<script type="text/javascript">
  (function() {
    "use strict";

    $(".task-list__task__delete").on("click", function (event) {
        var $this = $(this);

        $this.prop("disabled", true);

        $.ajax({
            url: "/lists/" + $this.attr("data-list-id") + "/tasks/" + $this.attr("data-task-id"),
            type: "DELETE",
            success: function () {
                window.location.reload();
            },
            error: function(error) {
                console.error(error);
            }
        });

        event.preventDefault();
        return false;
    });

    $(".task-state").on("mousedown", function () {
        var $this = $(this);
        $this.one("mouseup", function(event){
            var originalChecked = $this.prop("checked");
            var taskContainer = $this.parents(".task-list__task");

            $this.prop("disabled", true);

            $.ajax({
                url: "/lists/" + $this.attr("data-list-id") + "/tasks/" + $this.attr("data-task-id") + "/toggle",
                type: "POST",
                success: function () {
                    $this.prop("disabled", false);
                    taskContainer.toggleClass("task-list__task--done");
                    $this.prop("checked", !originalChecked);
                },
                error: function(error) {
                    $this.prop("disabled", false);
                    document.write(error.responseText);
                }
            });

            event.preventDefault();
        });
    });

    $("#new-task-title").on("keyup", function (event) {
      if(event.keyCode === 13){
        $("#add-new-task").click();
      }
    });

    $("#add-new-task").on("click", function (event) {
        var $name = $("#new-task-title");
        var name = $name.val();
        var $this = $(this);

        $name.removeClass("invalid");

        if (name) {
            $this.prop("disabled", true);

            $.ajax({
                url: "/lists/" + $this.attr("data-list-id") + "/tasks/new/" + name,
                type: "PUT",
                success: function () {
                    window.location.reload();
                },
                error: function(error) {
                    console.error(error);
                }
            });
        } else {
            $name.addClass("invalid");
        }

        event.preventDefault();
        return false;
    });

    // $("#reopen-list").on("click", function (event) {
    //     var $this = $(this);

    //     $this.prop("disabled", true);

    //     $.ajax({
    //         url: "/lists/" + $this.attr("data-list-id") + "/reopen",
    //         type: "POST",
    //         success: function () {
    //             window.location.reload();
    //         },
    //         error: function(error) {
    //             console.error(error);
    //         }
    //     });

    //     event.preventDefault();
    //     return false;
    // });
} ());
</script>